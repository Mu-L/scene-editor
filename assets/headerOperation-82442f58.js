import{n as P,ad as z,aa as A,a8 as N,a7 as j,ab as L,af as B,a6 as O}from"./index-b54f5418.js";import{J as Z}from"./index-cf27e902.js";import"./three-dc46505d.js";var q=function(){var e=this,c=e.$createElement,t=e._self._c||c;return t("div",{staticClass:"headerOperation-container"},[t("div",{staticClass:"operate-history"},[t("vis-icon",{attrs:{code:"#iconbianjiantouzuo"},nativeOn:{click:function(l){return(function(){e.$store.commit("appLibrary/backOffHistory")}).apply(null,arguments)}}}),t("vis-icon",{attrs:{code:"#iconbianjiantouyou"},nativeOn:{click:function(l){return(function(){e.$store.commit("appLibrary/forwardHistory")}).apply(null,arguments)}}})],1),t("div",{staticClass:"operate-address"},e._l(e.addressList,function(l,h){return t("span",{key:h,staticClass:"address-sign-box",on:{click:function(E){return e.chouseFile(l)}}},[h>0?t("vis-icon",{style:{transform:"scale(0.6)"},attrs:{code:"#iconsanjiaojiantouyou"}}):e._e(),t("span",{staticClass:"address-title",domProps:{textContent:e._s(l.name)}})],1)}),0),t("div",{staticClass:"operate-operation"},[t("el-popover",{attrs:{placement:"bottom",width:"200",trigger:"click"},model:{value:e.classifyVisible,callback:function(l){e.classifyVisible=l},expression:"classifyVisible"}},[t("el-input",{staticClass:"popover-input",attrs:{size:"mini",placeholder:"输入分类名称"},model:{value:e.classifyName,callback:function(l){e.classifyName=l},expression:"classifyName"}}),t("div",{staticClass:"popover-operation"},[t("el-button",{attrs:{size:"mini",type:"text"},on:{click:e.addClassify}},[e._v(" 确定 ")])],1),t("el-tooltip",{attrs:{slot:"reference",effect:"dark",content:"新增分类",placement:"top"},slot:"reference"},[t("vis-icon",{directives:[{name:"show",rawName:"v-show",value:e.canAddClassify,expression:"canAddClassify"}],attrs:{code:"#iconjia1"}})],1)],1),e.canUpload?t("vis-icon",{directives:[{name:"tooltip",rawName:"v-tooltip.top",value:"上传项目zip文件",expression:"'上传项目zip文件'",modifiers:{top:!0}}],attrs:{code:"#iconshangchuan-fill"},nativeOn:{click:function(l){return e.upload.apply(null,arguments)}}}):e._e(),t("input",{ref:"uploadInput",staticStyle:{display:"none"},attrs:{type:"file",accept:".zip"},on:{change:e.fileHandler}})],1)])},G=[];const K={data(){return{classifyName:"",classifyVisible:!1}},computed:{currentFloder(){return this.$store.getters["appLibrary/currentFloder"]},canUpload(){const e=this.currentFloder.children;return!e.length&&this.currentFloder.url!=="/"?!0:!!(e.length&&!e[0].dir)},canAddClassify(){const e=this.currentFloder.children;return e.length&&e[0].dir?!0:!e.length},addressList(){const e=[this.currentFloder],c=t=>{t.parent&&(e.unshift(t.parent),c(t.parent))};return c(this.currentFloder),e}},methods:{chouseFile(e){e.dir&&this.$store.commit("appLibrary/currentFloder",e)},upload(){this.$tool.safeTips().then(()=>{this.$refs.uploadInput.click()})},async fileHandler(e){const c=this.$loading({text:"正在上传应用项目...",background:"rgb(0, 0, 0)"}),t=e.target.files[0],l=this.currentFloder.id,f=(await new Z().loadAsync(t)).files;console.log(f);const y=f["app.json"],w=f["editor.json"],$=f["reference.json"];if(!y||!w||!$){this.$message.error("上传项目缺少核心文件。"),this.$refs.uploadInput.value="";return}const F=f["preview.png"];let i=await y.async("string"),S=await w.async("string");const p=JSON.parse(await $.async("string")),d=this.$tool.filesListToTree(f);console.log(d);const v=[],T=await z.addClassify({name:p.name});for(const o of Object.values(d.texture))for(const n in o){const s=o[n],a={id:(await z.uploadTexture({classifyId:T.id,name:n,texture:await s.async("blob"),ext:this.$tool.getFileExt(n),size:s._data.uncompressedSize})).id,module:"texture"},r=`/${s.name}`;v.push(a),i=i.replace(new RegExp(r,"g"),`<${a.module}-${a.id}>`)}const M=await A.addClassify({name:p.name});for(const o of Object.values(d.model)){const n=o,s=["fbx","glb","obj"],m=["jpg","png","jpeg"];let a=!1,r=null;for(const u of Object.keys(n))s.includes(this.$tool.getFileExt(u))&&(a=u),m.includes(this.$tool.getFileExt(u))&&(r=u);const H=await n[a].async("blob");let _=null;r&&(_=`data:image/${this.$tool.getFileExt(r)};base64,`+await n[r].async("base64"));const g={id:(await A.uploadModel({classifyId:M.id,name:a,model:H,ext:this.$tool.getFileExt(a),size:Object.values(n).reduce((u,k)=>k.dir?u:u+k._data.uncompressedSize,0),preview:_})).id,module:"model"},D=`/${n[a].name}`;v.push(g),i=i.replace(new RegExp(D,"g"),`<${g.module}-${g.id}>`)}const J=await N.addClassify({name:p.name});for(const o in d.component){const n=d.component[o],s=await this.$tool.parseNpmFiles(this.$tool.reduceFileListFolder(this.$tool.fileTreeToList(n))),a={id:(await N.uploadComponent({classifyId:J.id,name:s.pkg.description||s.pkg.name,component:s.scriptFile,pkg:s.pkg,preview:s.preview,size:s.preview})).id,module:"component"},r=`/component/${o}`;i=i.replace(new RegExp(r,"g"),`<${a.module}-${a.id}>`)}const b=[],U=await j.addClassify({name:p.name});for(const o in d.canvas){const n=d.canvas[o],s=await this.$tool.parseNpmFiles(this.$tool.reduceFileListFolder(this.$tool.fileTreeToList(n))),a={id:(await j.uploadCanvas({classifyId:U.id,name:s.pkg.description||s.pkg.name,canvas:s.scriptFile,pkg:s.pkg,preview:s.preview,size:s.preview})).id,module:"canvas"},r=`/canvas/${o}`;i=i.replace(new RegExp(r,"g"),`<${a.module}-${a.id}>`),b.push(a)}const x=[],R=await L.addClassify({name:p.name});for(const o in d.shader){const n=d.shader[o],s=await this.$tool.parseNpmFiles(this.$tool.reduceFileListFolder(this.$tool.fileTreeToList(n))),a={id:(await L.uploadShader({classifyId:R.id,name:s.pkg.description||s.pkg.name,shader:s.scriptFile,pkg:s.pkg,preview:s.preview,size:s.preview})).id,module:"shader"},r=`/shader/${o}`;i=i.replace(new RegExp(r,"g"),`<${a.module}-${a.id}>`),x.push(a)}i=JSON.parse(i,B.parse),i.assets=v,i.canvasAssets=b,i.shaderAssets=x;const C=JSON.parse(S);C.reference=p;const V=await O.creatApp({classifyId:l,name:p.name,app:i,editor:C,preview:F?await this.$tool.zipFileToBlob(F):""});this.$store.commit("appLibrary/addChildren",V),this.$message.success("上传成功！"),c.close()},addClassify(){this.classifyName.trim()?O.addClassify({name:this.classifyName.trim(),parentId:this.currentFloder.id}).then(e=>{this.$store.commit("appLibrary/addChildren",e),this.classifyName="",this.classifyVisible=!1,this.$message.success("添加分类成功！")}):(this.classifyName="",this.classifyVisible=!1)}}},I={};var Q=P(K,q,G,!1,W,"f98a6472",null,null);function W(e){for(let c in I)this[c]=I[c]}const te=function(){return Q.exports}();export{te as default};
