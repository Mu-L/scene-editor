import{e as i,c as m,_ as x}from"./index-cf27e902.js";import{n as g,i as n,ah as l,a9 as d,e as $}from"./index-b54f5418.js";import"./three-dc46505d.js";const p=["png","jpg","jpeg"],E=["mp4","wmv","webm","ogg"];var T=function(){var t=this,r=t.$createElement,e=t._self._c||r;return e("div",{staticClass:"texture-container"},[e("div",{staticClass:"box-header"},[e("el-input",{attrs:{size:"mini","prefix-icon":"el-icon-search",placeholder:"贴图筛选"}}),e("el-dropdown",{attrs:{trigger:"click"},on:{command:t.addtexture}},[e("el-button",{attrs:{size:"mini",icon:"el-icon-circle-plus-outline",type:"primary"}},[t._v(" 添加贴图 ")]),e("el-dropdown-menu",{attrs:{slot:"dropdown"},slot:"dropdown"},t._l(t.texture,function(s,a){return e("el-dropdown-item",{key:a,attrs:{command:s},domProps:{textContent:t._s(s.label)}})}),1)],1)],1),e("div",{staticClass:"box-container"},[e("div",{staticClass:"texture-main"},t._l(t.textureList,function(s,a){return e("div",{key:a,staticClass:"texture-elem"},[e("div",{ref:s.vid,refInFor:!0,staticClass:"render-box",class:{active:t.active.vid===s.vid},attrs:{id:s.vid},on:{click:function(){t.$store.commit("texture/setCurrentTexture",s.vid)}}}),e("div",{directives:[{name:"tooltip",rawName:"v-tooltip.top",value:"删除",expression:"'删除'",modifiers:{top:!0}}],staticClass:"operate-box",on:{click:function(o){return t.deleteTexture(s)}}},[e("vis-icon",{attrs:{code:"#iconshanchu",color:"red"}})],1),e("div",{directives:[{name:"tooltip",rawName:"v-tooltip.bottom",value:s.name,expression:"item.name",modifiers:{bottom:!0}}],staticClass:"element-title",domProps:{textContent:t._s(s.name)}})])}),0)]),e("texture-file-system",{ref:"textureFileSystem"}),e("canvas-file-system",{ref:"canvasFileSystem"})],1)},_=[];const y=()=>x(()=>import("./fileSystem-061079ea.js"),["assets/fileSystem-061079ea.js","assets/index-cf27e902.js","assets/index-b54f5418.js","assets/three-dc46505d.js","assets/index-f59973e2.css","assets/index-9ecf8d88.css","assets/fileSystem-7f54f11e.css"]),b=()=>x(()=>import("./fileSystem-66af7e95.js"),["assets/fileSystem-66af7e95.js","assets/index-cf27e902.js","assets/index-b54f5418.js","assets/three-dc46505d.js","assets/index-f59973e2.css","assets/index-9ecf8d88.css","assets/fileSystem-6f716f36.css"]),C={components:{textureFileSystem:y,canvasFileSystem:b},data(){return{texture:[{icon:"#icontexture",label:"图片贴图",type:n.IMAGETEXTURE},{icon:"#icontexture",label:"视频贴图",type:n.VIDEOTEXTURE},{icon:"#icontexture",label:"盒状贴图",type:n.CUBETEXTURE},{icon:"#icontexture",label:"加载贴图",type:n.LOADTEXTURE},{icon:"#icontexture",label:"画布贴图",type:n.CANVASTEXTURE}],canvasMap:{},watchMap:{}}},computed:{textureList(){return this.$store.getters["texture/get"]},active(){return this.$store.getters["texture/currentTexture"]},urls(){return this.$store.getters.urls}},watch:{textureList:{handler(t,r){this.$nextTick(()=>{Object.keys(t).forEach(e=>{if(!this.$refs[e])return console.error(`can not found this dom: '${e}'`),!1;if(this.canvasMap[e])return!1;const s=this.$refs[e][0],a=document.createElement("canvas");a.setAttribute("width",75),a.setAttribute("height",55),s.appendChild(a),this.canvasMap[e]=a,this.watchMap[e]=this.$watch(function(){return this.textureList[e]},o=>{this.updateTextureDisplay(e)},{deep:!0,immediate:!0})})})},immediate:!0}},methods:{addtexture(t){const r={[n.IMAGETEXTURE]:()=>this.$refs.textureFileSystem.open({confirm:({files:e})=>{this.loadTexture(e,t.type)},exts:p}),[n.CANVASTEXTURE]:()=>this.loadCanvasTexture(t),[n.CUBETEXTURE]:()=>this.$refs.textureFileSystem.open({confirm:({files:e})=>{this.loadCubeTexture(e)},exts:p}),[n.LOADTEXTURE]:()=>this.$refs.textureFileSystem.open({confirm:({files:e})=>{this.loadLoadTexture(e)},exts:["dds","hdr","cube","3dl"]}),[n.VIDEOTEXTURE]:()=>this.$refs.textureFileSystem.open({confirm:({files:e})=>{this.loadTexture(e)},exts:E})};r[t.type]?r[t.type]():this.$message.warning(`不支持的贴图类型：${t.type}`)},loadTexture(t,r){i.loadConfigAsync({assets:t.map(e=>({url:this.urls[`texture-${e.id}`],ext:e.ext}))}).then(e=>{t.forEach(s=>{const a=l(),o=d(r,{vid:a,url:this.urls[`texture-${s.id}`],name:`${s.name}${a.slice(-2)}`});this.$store.commit("texture/add",o)})})},loadCanvasTexture(t){this.$refs.canvasFileSystem.open({confirm:async({files:r})=>{const e=l(),s=d(t.type,{vid:e,name:`${t.label}-${e.slice(-2)}`,$version:0},{strict:!1});this.$store.commit("texture/add",s);const a=r[0];let c=this.$store.getters.urls[`canvas-${a.id}`];c||(c=URL.createObjectURL(a.canvas),this.$store.commit("cacheUrl",{module:"canvas",file:a,url:c}));const f=$.Message.loading("正在生成贴图..."),{config:u,packageJSON:v}=await i.generateCanvas(c,a.pkg,{$cid:l()});this.$store.commit("canvas/add",{config:u,configuration:v.configuration}),f.close(),s.url=u.$cid,i.canvasManager.eventDocking(u.$cid,s)}})},loadCubeTexture(t){const r={px:"",nx:"",py:"",ny:"",pz:"",nz:""},e=Object.keys(r);if(t.forEach(s=>{e.forEach(a=>{s.name.toLocaleLowerCase().includes(a)&&(r[a]=this.urls.get(s))})}),console.log(r),Object.values(r).includes("")){this.$message.warning("贴图素材不完整，需要选择6张相关天空盒贴图！");return}i.loadResourcesAsync(Object.values(r)).then(s=>{const a=l(),o=d(n.CUBETEXTURE,{vid:a,cube:r,name:`盒状贴图-${a.slice(-2)}`});this.$store.commit("texture/add",o)})},loadLoadTexture(t){console.log(t),i.loadConfigAsync({assets:t.map(r=>({url:this.urls[`texture-${r.id}`],ext:r.ext}))}).then(r=>{t.forEach(e=>{const s=i.generateLoadTextureConfig(this.urls[`texture-${e.id}`]);s.name=`${e.name}-${s.vid.slice(-2)}`,console.log(s),this.$store.commit("texture/add",s)})})},updateTextureDisplay(t){m.setTexture(i.compilerManager.getObjectBySymbol(t)).render();let r=new Image;r.src=m.getDataURL();const e=this.canvasMap[t];r.onload=()=>{e.getContext("2d").drawImage(r,0,0,75,55)}},deleteTexture(t){this.$confirm(`是否删除贴图：${t.name}，场景中使用了相关贴图的材质也会受到影响。`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.$store.commit("texture/remove",t.vid),this.$delete(this.canvasMap,t.vid);const r=this.watchMap[t.vid];r?r():console.warn("找不到这个vid的监听器",t.vid),this.$delete(this.watchMap,t.vid);let e=0;Object.values(this.$store.getters["material/get"]).forEach(s=>{let a=!1;Object.keys(s).forEach(o=>{o.toLocaleLowerCase().includes("map")&&s[o]===t.vid&&(s[o]="",a=!0)}),a&&(e+=1)}),this.$message({type:"success",message:`删除成功! 影响了：${e} 个材质。`})})}}},h={};var w=g(C,T,_,!1,U,"0df1b510",null,null);function U(t){for(let r in h)this[r]=h[r]}const L=function(){return w.exports}();export{L as default};
