import{e as n,h as r}from"./index-2b47d9b6.js";import{n as d,a6 as c,af as g}from"./index-2dfd5781.js";import"./three-c85558b8.js";var p=function(){var e=this,i=e.$createElement,t=e._self._c||i;return t("div",{staticClass:"operateNavigation-container"},[t("el-button",{attrs:{size:"mini",type:"primary"},on:{click:function(s){e.screenshotDialogVisible=!0}}},[e._v(" 快照 ")]),t("el-button",{attrs:{loading:e.autoSave.saving,disable:e.autoSave.saving,size:"mini",type:"success"},on:{click:e.save}},[e._v(" "+e._s(e.autoSave.saving?"自动保存":"保存")+" ")]),t("el-button",{attrs:{size:"mini",type:"info"},on:{click:e.display}},[e._v("展示")]),t("el-button",{attrs:{size:"mini",type:"info"},on:{click:e.download}},[e._v("导出")]),t("el-dialog",{attrs:{title:"快照设置",visible:e.screenshotDialogVisible,width:"30%",center:""},on:{"update:visible":function(s){e.screenshotDialogVisible=s}}},[t("el-form",{attrs:{"label-position":"left","label-width":"90px"}},[t("el-form-item",{attrs:{label:"文件名"}},[t("el-input",{attrs:{size:"mini"},model:{value:e.screenshotSetting.name,callback:function(s){e.$set(e.screenshotSetting,"name",s)},expression:"screenshotSetting.name"}})],1),t("el-form-item",{attrs:{label:"宽度（px）"}},[t("el-input-number",{attrs:{size:"mini",controls:!1},model:{value:e.screenshotSetting.width,callback:function(s){e.$set(e.screenshotSetting,"width",s)},expression:"screenshotSetting.width"}})],1),t("el-form-item",{attrs:{label:"高度（px）"}},[t("el-input-number",{attrs:{size:"mini",controls:!1},model:{value:e.screenshotSetting.height,callback:function(s){e.$set(e.screenshotSetting,"height",s)},expression:"screenshotSetting.height"}})],1)],1),t("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{attrs:{size:"mini"},on:{click:function(s){e.screenshotDialogVisible=!1}}},[e._v(" 取 消 ")]),t("el-button",{attrs:{size:"mini",type:"primary"},on:{click:e.getScreenshot}},[e._v(" 确 定 ")])],1)],1)],1)},m=[];const u={data(){return{screenshotDialogVisible:!1,buildDialogVisible:!1,screenshotSetting:{width:1920,height:1080,name:"vis-screenshot"},exportSetting:{name:"vis-scene"},autoSave:{saving:!1,time:1e3*180},timer:""}},computed:{name(){return this.$store.getters.name},id(){return this.$store.getters.id}},mounted(){n.keyboardManager.register({shortcutKey:["ctrl","s"],desp:"在线保存",keydown:e=>{e.preventDefault(),e.stopPropagation(),this.save()}}),this.timer=window.setInterval(()=>{this.autoSaveHanlder()},this.autoSave.time)},destroyed(){clearInterval(this.timer)},methods:{async getScreenshot(){const e=await n.getScreenshot({width:this.screenshotSetting.width,height:this.screenshotSetting.height}),i=document.createElement("a");i.download=this.screenshotSetting.name,i.href=e,i.click(),this.screenshotDialogVisible=!1,this.screenshotSetting={width:1920,height:1080,name:"vis-screenshot"}},async save(){const e=this.$loading({text:"正在保存...",background:"rgb(0, 0, 0)",target:".renderWindow-container"}),i=await this.$store.dispatch("exportConfig"),t=await n.getScreenshot({width:1920,height:1080});let s=await this.$store.dispatch("urlTransform",n.exportConfig());await c.saveApp({id:this.id,name:this.name,app:s,editor:i,preview:t}).catch(a=>{this.$message.error("接口有误：appApi/saveApp"),console.error(a)}),await r.creatHistory({appId:this.id,date:new Date().getTime(),name:this.name,app:s,editor:i,preview:t,mode:"manual"}).catch(a=>{this.$message.error("接口有误：historyApi/creatHistory"),console.error(a)}),this.$message.success("保存成功！"),e.close()},async autoSaveHanlder(){this.autoSave.saving=!0;const e=await this.$store.dispatch("exportConfig");let i=await this.$store.dispatch("urlTransform",n.exportConfig());await c.saveApp({id:this.id,name:this.name,app:i,editor:e}).catch(t=>{this.$message.error("appApi/saveApp"),console.error(t)}),await r.creatHistory({appId:this.id,date:new Date().getTime(),name:this.name,app:i,editor:e,preview:"",mode:"auto"}).catch(t=>{this.$message.error("接口有误：historyApi/creatHistory"),console.error(t)}),this.autoSave.saving=!1,this.$notify.success({title:"自动保存成功。",message:"时间："+new Date().toLocaleString()})},display(){window.open(window.location.origin+window.location.pathname+`/preview.html?id=${this.id}`)},async download(){const e=this.$loading({text:"正在打包项目...",background:"rgb(0, 0, 0)",target:".renderWindow-container"}),i=await this.$store.dispatch("exportConfig"),t=await n.getScreenshot({width:1920,height:1080}),{app:s,zip:a}=await this.$store.dispatch("exportTransform",n.exportConfig());a.file("editor.json",JSON.stringify(i)),a.file("app.json",JSON.stringify(s,g.stringify)),a.file("reference.json",JSON.stringify({id:this.$store.getters.id,name:this.$store.getters.name,type:"app",date:new Date().toLocaleString(),encode:window.VIS.encode,version:window.VIS.version,webgl:{memory:n.webGLRenderer.info.memory,render:n.webGLRenderer.info.render},system:{url:window.location.href,user:window.navigator.userAgent,languages:window.navigator.languages}})),a.file("preview.png",this.$tool.dataURLToBlob(t));const h=await a.generateAsync({type:"blob"}),o=document.createElement("a");o.download=`${this.$store.getters.name}.zip`,o.href=URL.createObjectURL(h),o.click(),e.close()}}},l={};var v=d(u,p,m,!1,w,"513e8e90",null,null);function w(e){for(let i in l)this[i]=l[i]}const S=function(){return v.exports}();export{S as default};
