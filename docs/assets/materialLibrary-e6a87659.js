import{n as u,C as n,v as h,g as p,m as d,e as v}from"./index-ea23a1e9.js";import"./three-6daa312a.js";var g=function(){var e=this,i=e.$createElement,t=e._self._c||i;return t("div",{staticClass:"material-container"},[t("div",{staticClass:"box-header"},[t("el-input",{attrs:{size:"mini","prefix-icon":"el-icon-search",placeholder:"材质筛选"}}),t("el-dropdown",{attrs:{trigger:"click"},on:{command:e.addMaterial}},[t("el-button",{attrs:{size:"mini",icon:"el-icon-circle-plus-outline",type:"primary"}},[e._v(" 添加材质 ")]),t("el-dropdown-menu",{attrs:{slot:"dropdown"},slot:"dropdown"},e._l(e.material,function(a,s){return t("el-dropdown-item",{key:s,attrs:{command:a},domProps:{textContent:e._s(a.label)}})}),1)],1)],1),t("div",{staticClass:"box-container"},[t("div",{staticClass:"material-main"},e._l(e.materialList,function(a,s){return t("div",{key:s,staticClass:"material-elem",on:{mousedown:function(r){return e.changeCurrentMaterial(a.vid)}}},[t("div",{ref:a.vid,refInFor:!0,staticClass:"render-box",class:{active:e.currentMaterial.vid===a.vid},attrs:{draggable:"true",id:a.vid},on:{dragstart:function(r){return e.dragstart(r,a.vid)}}}),t("div",{directives:[{name:"tooltip",rawName:"v-tooltip.top",value:"删除",expression:"'删除'",modifiers:{top:!0}}],staticClass:"operate-box",on:{click:function(r){return e.deleteMaterial(a)}}},[t("vis-icon",{attrs:{code:"#iconshanchu",color:"red"}})],1),t("div",{directives:[{name:"tooltip",rawName:"v-tooltip.bottom",value:a.name,expression:"item.name",modifiers:{bottom:!0}}],staticClass:"element-title",domProps:{textContent:e._s(a.name)}})])}),0)])])},f=[];const M={data(){return{material:[{icon:"#icondengpao",label:"基础网格材质",material:n.MESHBASICMATERIAL},{icon:"#icondengpao",label:"Phong网格材质",material:n.MESHPHONGMATERIAL},{icon:"#icondengpao",label:"标准网格材质",material:n.MESHSTANDARDMATERIAL},{icon:"#icondengpao",label:"物理网格材质",material:n.MESHPHYSICALMATERIAL},{icon:"#icondengpao",label:"精灵材质",material:n.SPRITEMATERIAL},{icon:"#icondengpao",label:"基础线条材质",material:n.LINEBASICMATERIAL}],canvasMap:{},watchMap:{},timer:"",throttleTime:1e3/45,canMove:!0}},computed:{materialList(){return this.$store.getters["material/get"]},currentMaterial(){return this.$store.getters["active/material"]}},methods:{dragstart(e,i){e.preventDefault(),this.$store.commit("material/setDraggedMaterial",i);const a=e.target.getElementsByTagName("canvas");if(a.length>0){this.$store.commit("material/dragging",!0);const s=a[0],r=new Image;r.src=s.toDataURL("image/png"),r.style.position="fixed",r.style.zIndex=20,r.style.opacity=.6,document.body.appendChild(r);const l=o=>{this.canMove&&(this.canMove=!1,this.timer=setTimeout(()=>{r.style.top=`${o.clientY+10}px`,r.style.left=`${o.clientX+10}px`,this.canMove=!0},this.throttleTime))},c=o=>{document.body.removeChild(r),document.body.removeEventListener("mousemove",l),document.body.removeEventListener("mouseup",c)};document.body.addEventListener("mousemove",l),document.body.addEventListener("mouseup",c)}else console.error("can not found canvas in this dom")},addMaterial(e){const i=h(),t=p(e.material,{vid:i,name:e.label+i.slice(0,2)});this.$store.commit("material/add",t),this.changeCurrentMaterial(t.vid)},changeCurrentMaterial(e){const i=this.$store.getters["material/get"][e];this.$store.commit("active/material",i)},updateMaterialDisplay(e){d.setMaterial(v.compilerManager.getObjectBySymbol(e)).render();let i=new Image;i.src=d.getDataURL();const t=this.canvasMap[e];i.onload=()=>{t.getContext("2d").drawImage(i,0,0,75,55)}},deleteMaterial(e){this.$confirm(`是否删除材质：${e.name}，场景中使用了相关材质的物体也会受到影响。`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.$store.commit("material/remove",e.vid),this.$delete(this.canvasMap,e.vid);const i=this.watchMap[e.vid];i?i():console.warn("找不到这个vid的监听器",e.vid),this.$delete(this.watchMap,e.vid);const t=[this.$store.getters["mesh/get"],this.$store.getters["line/get"],this.$store.getters["sprite/get"]];let a=0;t.forEach(s=>{Object.values(s).forEach(r=>{Array.isArray(r.material)&&r.material.includes(e.vid)?(a+=1,r.material.forEach((l,c,o)=>{l===e.vid&&o.splice(c,1)})):r.material&&r.material===e.vid&&(r.material="",a+=1)})}),this.$message({type:"success",message:`删除成功! 影响了：${a} 个物体。`})})}},watch:{materialList:{handler(e,i){this.$nextTick(()=>{Object.keys(e).forEach(t=>{if(!this.$refs[t])return console.error(`can not found this dom: '${t}'`),!1;if(this.canvasMap[t])return!1;const a=this.$refs[t][0],s=document.createElement("canvas");s.setAttribute("width",75),s.setAttribute("height",55),a.appendChild(s),this.canvasMap[t]=s,this.watchMap[t]=this.$watch(function(){return this.materialList[t]},r=>{this.$nextTick(()=>{this.updateMaterialDisplay(t)})},{deep:!0,immediate:!0})})})},immediate:!0}},mounted(){}},m={};var b=u(M,g,f,!1,y,"b7da2d06",null,null);function y(e){for(let i in m)this[i]=m[i]}const C=function(){return b.exports}();export{C as default};
