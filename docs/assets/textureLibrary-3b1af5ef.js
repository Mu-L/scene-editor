import{n as m,C as o,e as i,j as c,g as l,t as u,_ as h}from"./index-b8043f0c.js";import{c5 as f,w as v,L as d}from"./three-6daa312a.js";var x=function(){var e=this,r=e.$createElement,t=e._self._c||r;return t("div",{staticClass:"texture-container"},[t("div",{staticClass:"box-header"},[t("el-input",{attrs:{size:"mini","prefix-icon":"el-icon-search",placeholder:"贴图筛选"}}),t("el-dropdown",{attrs:{trigger:"click"},on:{command:e.addtexture}},[t("el-button",{attrs:{size:"mini",icon:"el-icon-circle-plus-outline",type:"primary"}},[e._v(" 添加贴图 ")]),t("el-dropdown-menu",{attrs:{slot:"dropdown"},slot:"dropdown"},e._l(e.texture,function(s,n){return t("el-dropdown-item",{key:n,attrs:{command:s},domProps:{textContent:e._s(s.label)}})}),1)],1)],1),t("div",{staticClass:"box-container"},[t("div",{staticClass:"texture-main"},e._l(e.textureList,function(s,n){return t("div",{key:n,staticClass:"texture-elem"},[t("div",{ref:s.vid,refInFor:!0,staticClass:"render-box",class:{active:e.active.vid===s.vid},attrs:{id:s.vid},on:{click:function(){e.$store.commit("texture/setCurrentTexture",s.vid)}}}),t("div",{directives:[{name:"tooltip",rawName:"v-tooltip.top",value:"删除",expression:"'删除'",modifiers:{top:!0}}],staticClass:"operate-box",on:{click:function(a){return e.deleteTexture(s)}}},[t("vis-icon",{attrs:{code:"#iconshanchu",color:"red"}})],1),t("div",{directives:[{name:"tooltip",rawName:"v-tooltip.bottom",value:s.name,expression:"item.name",modifiers:{bottom:!0}}],staticClass:"element-title",domProps:{textContent:e._s(s.name)}})])}),0)]),t("file-system",{ref:"fileSystem"})],1)},g=[];const _=()=>h(()=>import("./fileSystem-70316ce4.js"),["assets/fileSystem-70316ce4.js","assets/index-b8043f0c.js","assets/three-6daa312a.js","assets/index-3dbea7c4.css","assets/fileSystem-b1beecf9.css"]),y={components:{fileSystem:_},data(){return{texture:[{icon:"#icontexture",label:"图片贴图",type:o.IMAGETEXTURE},{icon:"#icontexture",label:"视频贴图",type:o.VIDEOTEXTURE},{icon:"#icontexture",label:"盒状贴图",type:o.CUBETEXTURE},{icon:"#icontexture",label:"加载贴图",type:o.LOADTEXTURE}],canvasMap:{},watchMap:{}}},computed:{textureList(){return this.$store.getters["texture/get"]},active(){return this.$store.getters["texture/currentTexture"]},urls(){return this.$store.getters["textureLibrary/urls"]}},methods:{addtexture(e){this.$refs.fileSystem.open({confirm:({files:r})=>{if(console.log(r),e.type===o.CUBETEXTURE){this.loadCubeTexture(r);return}if(e.type===o.LOADTEXTURE){this.loadLoadTexture(r);return}this.loadTexture(r,e.type)}})},loadTexture(e,r){i.loadConfigAsync({assets:e.map(t=>({url:this.urls.get(t),ext:t.ext}))}).then(t=>{e.forEach(s=>{const n=c(),a=l(r,{vid:n,url:this.urls.get(s),name:`${s.name}${n.slice(-2)}`});this.$store.commit("texture/add",a)})})},loadCubeTexture(e){const r={px:"",nx:"",py:"",ny:"",pz:"",nz:""},t=Object.keys(r);if(e.forEach(s=>{t.forEach(n=>{s.name.toLocaleLowerCase().includes(n)&&(r[n]=this.urls.get(s))})}),console.log(r),Object.values(r).includes("")){this.$message.warning("贴图素材不完整，需要选择6张相关天空盒贴图！");return}i.loadResourcesAsync(Object.values(r)).then(s=>{const n=c(),a=l(o.CUBETEXTURE,{vid:n,cube:r,name:`盒状贴图-${n.slice(-2)}`});this.$store.commit("texture/add",a)})},loadLoadTexture(e){console.log(e),i.loadConfigAsync({assets:e.map(r=>({url:this.urls.get(r),ext:r.ext}))}).then(r=>{e.forEach(t=>{const s=c(),n=l(o.LOADTEXTURE,{vid:s,url:this.urls.get(t),name:`${t.name}${s.slice(-2)}`,mapping:f,flipY:!0,encoding:v,minFilter:d,magFilter:d});console.log(n.vid),this.$store.commit("texture/add",n)})})},updateTextureDisplay(e){u.setTexture(i.compilerManager.getObjectBySymbol(e)).render();let r=new Image;r.src=u.getDataURL();const t=this.canvasMap[e];r.onload=()=>{t.getContext("2d").drawImage(r,0,0,75,55)}},deleteTexture(e){this.$confirm(`是否删除贴图：${e.name}，场景中使用了相关贴图的材质也会受到影响。`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.$store.commit("texture/remove",e.vid),this.$delete(this.canvasMap,e.vid);const r=this.watchMap[e.vid];r?r():console.warn("找不到这个vid的监听器",e.vid),this.$delete(this.watchMap,e.vid);let t=0;Object.values(this.$store.getters["material/get"]).forEach(s=>{let n=!1;Object.keys(s).forEach(a=>{a.toLocaleLowerCase().includes("map")&&s[a]===e.vid&&(s[a]="",n=!0)}),n&&(t+=1)}),this.$message({type:"success",message:`删除成功! 影响了：${t} 个材质。`})})}},watch:{textureList:{handler(e,r){this.$nextTick(()=>{Object.keys(e).forEach(t=>{if(!this.$refs[t])return console.error(`can not found this dom: '${t}'`),!1;if(this.canvasMap[t])return!1;const s=this.$refs[t][0],n=document.createElement("canvas");n.setAttribute("width",75),n.setAttribute("height",55),s.appendChild(n),this.canvasMap[t]=n,this.watchMap[t]=this.$watch(function(){return this.textureList[t]},a=>{this.updateTextureDisplay(t)},{deep:!0,immediate:!0})})})},immediate:!0}}},p={};var E=m(y,x,g,!1,T,"7f32c906",null,null);function T(e){for(let r in p)this[r]=p[r]}const C=function(){return E.exports}();export{C as default};
