import{e as u,b as h,_ as v}from"./index-2b47d9b6.js";import{n as g,i as n,a9 as d}from"./index-2dfd5781.js";import"./three-c85558b8.js";var f=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"material-container"},[i("div",{staticClass:"box-header"},[i("el-input",{attrs:{size:"mini","prefix-icon":"el-icon-search",placeholder:"材质筛选"}}),i("el-dropdown",{attrs:{trigger:"click"},on:{command:e.addMaterial}},[i("el-button",{attrs:{size:"mini",icon:"el-icon-circle-plus-outline",type:"primary"}},[e._v(" 添加材质 ")]),i("el-dropdown-menu",{attrs:{slot:"dropdown"},slot:"dropdown"},e._l(e.material,function(a,s){return i("el-dropdown-item",{key:s,attrs:{command:a},domProps:{textContent:e._s(a.label)}})}),1)],1)],1),i("div",{staticClass:"box-container"},[i("div",{staticClass:"material-main"},e._l(e.materialList,function(a,s){return i("div",{key:s,staticClass:"material-elem",on:{mousedown:function(r){return e.changeCurrentMaterial(a.vid)}}},[i("div",{ref:a.vid,refInFor:!0,staticClass:"render-box",class:{active:e.currentMaterial.vid===a.vid},attrs:{id:a.vid,draggable:"true"},on:{dragstart:function(r){return e.dragstart(r,a.vid)}}}),i("div",{directives:[{name:"tooltip",rawName:"v-tooltip.top",value:"删除",expression:"'删除'",modifiers:{top:!0}}],staticClass:"operate-box",on:{click:function(r){return e.deleteMaterial(a)}}},[i("vis-icon",{attrs:{code:"#iconshanchu",color:"red"}})],1),i("div",{directives:[{name:"tooltip",rawName:"v-tooltip.bottom",value:a.name,expression:"item.name",modifiers:{bottom:!0}}],staticClass:"element-title",domProps:{textContent:e._s(a.name)}})])}),0)]),i("file-system",{ref:"fileSystem"})],1)},M=[];const b=()=>v(()=>import("./fileSystem-b07fe9fe.js"),["assets/fileSystem-b07fe9fe.js","assets/index-2b47d9b6.js","assets/index-2dfd5781.js","assets/three-c85558b8.js","assets/index-0a056b01.css","assets/index-4c2ff732.css","assets/fileSystem-469242b5.css"]),_={components:{fileSystem:b},data(){return{material:[{icon:"#icondengpao",label:"基础网格材质",material:n.MESHBASICMATERIAL},{icon:"#icondengpao",label:"Phong网格材质",material:n.MESHPHONGMATERIAL},{icon:"#icondengpao",label:"标准网格材质",material:n.MESHSTANDARDMATERIAL},{icon:"#icondengpao",label:"物理网格材质",material:n.MESHPHYSICALMATERIAL},{icon:"#icondengpao",label:"精灵材质",material:n.SPRITEMATERIAL},{icon:"#icondengpao",label:"基础线条材质",material:n.LINEBASICMATERIAL},{icon:"#icondengpao",label:"着色器材质",material:n.SHADERMATERIAL}],canvasMap:{},watchMap:{},timer:"",throttleTime:1e3/45,canMove:!0}},computed:{materialList(){return this.$store.getters["material/get"]},currentMaterial(){return this.$store.getters["active/material"]}},watch:{materialList:{handler(e){this.$nextTick(()=>{Object.keys(e).forEach(t=>{if(!this.$refs[t])return console.error(`can not found this dom: '${t}'`),!1;if(this.canvasMap[t])return!1;const i=this.$refs[t][0],a=document.createElement("canvas");a.setAttribute("width",75),a.setAttribute("height",55),i.appendChild(a),this.canvasMap[t]=a,this.watchMap[t]=this.$watch(function(){return this.materialList[t]},s=>{this.$nextTick(()=>{this.updateMaterialDisplay(t)})},{deep:!0,immediate:!0})})})},immediate:!0}},mounted(){},methods:{dragstart(e,t){e.preventDefault(),this.$store.commit("material/setDraggedMaterial",t);const a=e.target.getElementsByTagName("canvas");if(a.length>0){this.$store.commit("material/dragging",!0);const s=a[0],r=new Image;r.src=s.toDataURL("image/png"),r.style.position="fixed",r.style.zIndex=20,r.style.opacity=.6,document.body.appendChild(r);const o=c=>{this.canMove&&(this.canMove=!1,this.timer=setTimeout(()=>{r.style.top=`${c.clientY+10}px`,r.style.left=`${c.clientX+10}px`,this.canMove=!0},this.throttleTime))},l=()=>{document.body.removeChild(r),document.body.removeEventListener("mousemove",o),document.body.removeEventListener("mouseup",l)};document.body.addEventListener("mousemove",o),document.body.addEventListener("mouseup",l)}else console.error("can not found canvas in this dom")},addMaterial(e){if(e.material===n.SHADERMATERIAL){this.addShaderMaterial(e);return}const t=d(e.material);t.name=e.label+t.vid.slice(0,2),this.$store.commit("material/add",t),this.changeCurrentMaterial(t.vid)},addShaderMaterial(e){const t=d(n.SHADERMATERIAL,{},{observer:!1});t.name=e.label+t.vid.slice(0,2),this.$refs.fileSystem.open({confirm:async({files:i})=>{const a=i[0],s=this.$message.loading("正在生成材质...");let o=this.$store.getters.urls[`shader-${a.id}`];o||(o=URL.createObjectURL(a.shader),this.$store.commit("cacheUrl",{module:"shader",file:a,url:o}));const{config:l,packageJSON:c}=await u.generateShader(o,a.pkg,t.vid);this.$store.commit("shader/add",{vid:t.vid,configuration:c.configuration}),t.shader=l.shader,Object.assign(t.uniforms,l.uniforms),console.log(this.config),s.close();const m=d(t.type,t,{strict:!1});this.$store.commit("material/add",m),this.changeCurrentMaterial(m.vid)}})},changeCurrentMaterial(e){const t=this.$store.getters["material/get"][e];this.$store.commit("active/material",t),this.$store.commit("active/functionModule","material")},updateMaterialDisplay(e){h.setMaterial(u.compilerManager.getObjectBySymbol(e)).render();let t=new Image;t.src=h.getDataURL();const i=this.canvasMap[e];t.onload=()=>{i.getContext("2d").drawImage(t,0,0,75,55)}},deleteMaterial(e){this.$confirm(`是否删除材质：${e.name}，场景中使用了相关材质的物体也会受到影响。`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.$store.commit("material/remove",e.vid),this.$delete(this.canvasMap,e.vid);const t=this.watchMap[e.vid];t?t():console.warn("找不到这个vid的监听器",e.vid),this.$delete(this.watchMap,e.vid);const i=[this.$store.getters["mesh/get"],this.$store.getters["line/get"],this.$store.getters["sprite/get"]];let a=0;i.forEach(s=>{Object.values(s).forEach(r=>{Array.isArray(r.material)&&r.material.includes(e.vid)?(a+=1,r.material.forEach((o,l,c)=>{o===e.vid&&c.splice(l,1)})):r.material&&r.material===e.vid&&(r.material="",a+=1)})}),this.$message({type:"success",message:`删除成功! 影响了：${a} 个物体。`})})}}},p={};var y=g(_,f,M,!1,$,"6deb518f",null,null);function $(e){for(let t in p)this[t]=p[t]}const C=function(){return y.exports}();export{C as default};
