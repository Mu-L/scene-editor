import{e as i,b as m,_ as h}from"./index-74278c3c.js";import{n as f,i as o,ah as l,a9 as d,e as g}from"./texture-7d506f8b.js";import"./three-c85558b8.js";var _=function(){var e=this,r=e.$createElement,t=e._self._c||r;return t("div",{staticClass:"texture-container"},[t("div",{staticClass:"box-header"},[t("el-input",{attrs:{size:"mini","prefix-icon":"el-icon-search",placeholder:"贴图筛选"}}),t("el-dropdown",{attrs:{trigger:"click"},on:{command:e.addtexture}},[t("el-button",{attrs:{size:"mini",icon:"el-icon-circle-plus-outline",type:"primary"}},[e._v(" 添加贴图 ")]),t("el-dropdown-menu",{attrs:{slot:"dropdown"},slot:"dropdown"},e._l(e.texture,function(s,a){return t("el-dropdown-item",{key:a,attrs:{command:s},domProps:{textContent:e._s(s.label)}})}),1)],1)],1),t("div",{staticClass:"box-container"},[t("div",{staticClass:"texture-main"},e._l(e.textureList,function(s,a){return t("div",{key:a,staticClass:"texture-elem"},[t("div",{ref:s.vid,refInFor:!0,staticClass:"render-box",class:{active:e.active.vid===s.vid},attrs:{id:s.vid},on:{click:function(){e.$store.commit("texture/setCurrentTexture",s.vid)}}}),t("div",{directives:[{name:"tooltip",rawName:"v-tooltip.top",value:"删除",expression:"'删除'",modifiers:{top:!0}}],staticClass:"operate-box",on:{click:function(n){return e.deleteTexture(s)}}},[t("vis-icon",{attrs:{code:"#iconshanchu",color:"red"}})],1),t("div",{directives:[{name:"tooltip",rawName:"v-tooltip.bottom",value:s.name,expression:"item.name",modifiers:{bottom:!0}}],staticClass:"element-title",domProps:{textContent:e._s(s.name)}})])}),0)]),t("texture-file-system",{ref:"textureFileSystem"}),t("canvas-file-system",{ref:"canvasFileSystem"})],1)},$=[];const y=()=>h(()=>import("./fileSystem-e24422e0.js"),["assets/fileSystem-e24422e0.js","assets/index-74278c3c.js","assets/texture-7d506f8b.js","assets/three-c85558b8.js","assets/texture-d7471725.css","assets/index-4514b76b.css","assets/fileSystem-120b6a97.css"]),T=()=>h(()=>import("./fileSystem-0d813532.js"),["assets/fileSystem-0d813532.js","assets/index-74278c3c.js","assets/texture-7d506f8b.js","assets/three-c85558b8.js","assets/texture-d7471725.css","assets/index-4514b76b.css","assets/fileSystem-6f716f36.css"]),E={components:{textureFileSystem:y,canvasFileSystem:T},data(){return{texture:[{icon:"#icontexture",label:"图片贴图",type:o.IMAGETEXTURE},{icon:"#icontexture",label:"视频贴图",type:o.VIDEOTEXTURE},{icon:"#icontexture",label:"盒状贴图",type:o.CUBETEXTURE},{icon:"#icontexture",label:"加载贴图",type:o.LOADTEXTURE},{icon:"#icontexture",label:"画布贴图",type:o.CANVASTEXTURE}],canvasMap:{},watchMap:{}}},computed:{textureList(){return this.$store.getters["texture/get"]},active(){return this.$store.getters["texture/currentTexture"]},urls(){return this.$store.getters.urls}},watch:{textureList:{handler(e,r){this.$nextTick(()=>{Object.keys(e).forEach(t=>{if(!this.$refs[t])return console.error(`can not found this dom: '${t}'`),!1;if(this.canvasMap[t])return!1;const s=this.$refs[t][0],a=document.createElement("canvas");a.setAttribute("width",75),a.setAttribute("height",55),s.appendChild(a),this.canvasMap[t]=a,this.watchMap[t]=this.$watch(function(){return this.textureList[t]},n=>{this.updateTextureDisplay(t)},{deep:!0,immediate:!0})})})},immediate:!0}},methods:{addtexture(e){e.type===o.CANVASTEXTURE?this.loadCanvasTexture(e):this.$refs.textureFileSystem.open({confirm:({files:r})=>{if(e.type===o.CUBETEXTURE){this.loadCubeTexture(r);return}if(e.type===o.LOADTEXTURE){this.loadLoadTexture(r);return}this.loadTexture(r,e.type)}})},loadTexture(e,r){i.loadConfigAsync({assets:e.map(t=>({url:this.urls[`texture-${t.id}`],ext:t.ext}))}).then(t=>{e.forEach(s=>{const a=l(),n=d(r,{vid:a,url:this.urls[`texture-${s.id}`],name:`${s.name}${a.slice(-2)}`});this.$store.commit("texture/add",n)})})},loadCanvasTexture(e){this.$refs.canvasFileSystem.open({confirm:async({files:r})=>{const t=l(),s=d(e.type,{vid:t,name:`${e.label}-${t.slice(-2)}`});this.$store.commit("texture/add",s);const a=r[0];let c=this.$store.getters.urls[`canvas-${a.id}`];c||(c=URL.createObjectURL(a.canvas),this.$store.commit("cacheUrl",{module:"canvas",file:a,url:c}));const x=g.Message.loading("正在生成贴图..."),{config:u,packageJSON:v}=await i.generateCanvas(c,a.pkg,{$cid:l()});this.$store.commit("canvas/add",{config:u,configuration:v.configuration}),x.close(),s.url=u.$cid,i.canvasManager.eventDocking(u.$cid,s)}})},loadCubeTexture(e){const r={px:"",nx:"",py:"",ny:"",pz:"",nz:""},t=Object.keys(r);if(e.forEach(s=>{t.forEach(a=>{s.name.toLocaleLowerCase().includes(a)&&(r[a]=this.urls.get(s))})}),console.log(r),Object.values(r).includes("")){this.$message.warning("贴图素材不完整，需要选择6张相关天空盒贴图！");return}i.loadResourcesAsync(Object.values(r)).then(s=>{const a=l(),n=d(o.CUBETEXTURE,{vid:a,cube:r,name:`盒状贴图-${a.slice(-2)}`});this.$store.commit("texture/add",n)})},loadLoadTexture(e){console.log(e),i.loadConfigAsync({assets:e.map(r=>({url:this.urls[`texture-${r.id}`],ext:r.ext}))}).then(r=>{e.forEach(t=>{const s=i.generateLoadTextureConfig(this.urls[`texture-${t.id}`]);s.name=`${t.name}-${s.vid.slice(-2)}`,console.log(s),this.$store.commit("texture/add",s)})})},updateTextureDisplay(e){m.setTexture(i.compilerManager.getObjectBySymbol(e)).render();let r=new Image;r.src=m.getDataURL();const t=this.canvasMap[e];r.onload=()=>{t.getContext("2d").drawImage(r,0,0,75,55)}},deleteTexture(e){this.$confirm(`是否删除贴图：${e.name}，场景中使用了相关贴图的材质也会受到影响。`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.$store.commit("texture/remove",e.vid),this.$delete(this.canvasMap,e.vid);const r=this.watchMap[e.vid];r?r():console.warn("找不到这个vid的监听器",e.vid),this.$delete(this.watchMap,e.vid);let t=0;Object.values(this.$store.getters["material/get"]).forEach(s=>{let a=!1;Object.keys(s).forEach(n=>{n.toLocaleLowerCase().includes("map")&&s[n]===e.vid&&(s[n]="",a=!0)}),a&&(t+=1)}),this.$message({type:"success",message:`删除成功! 影响了：${t} 个材质。`})})}}},p={};var b=f(E,_,$,!1,C,"1ee2aa0f",null,null);function C(e){for(let r in p)this[r]=p[r]}const L=function(){return b.exports}();export{L as default};
